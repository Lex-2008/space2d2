(()=>{var He=Object.create;var me=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var Ae=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var Ge=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var Ie=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Ve=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ze(e))!je.call(t,i)&&i!==r&&me(t,i,{get:()=>e[i],enumerable:!(n=$e(e,i))||n.enumerable});return t};var ge=(t,e,r)=>(r=t!=null?He(Ae(t)):{},Ve(e||!t||!t.__esModule?me(r,"default",{value:t,enumerable:!0}):r,t));var Ce=Ie((ue,Pe)=>{(function(t,e){"use strict";typeof define=="function"&&define.amd?define([],e):typeof ue=="object"?Pe.exports=e():t.textFit=e()})(typeof global=="object"?global:ue,function(){"use strict";var t={alignVert:!1,alignHoriz:!1,multiLine:!1,detectMultiLine:!0,minFontSize:6,maxFontSize:80,reProcess:!0,widthOnly:!1,alignVertWithFlexbox:!1};return function(a,u){u||(u={});var v={};for(var m in t)u.hasOwnProperty(m)?v[m]=u[m]:v[m]=t[m];typeof a.toArray=="function"&&(a=a.toArray());var T=Object.prototype.toString.call(a);T!=="[object Array]"&&T!=="[object NodeList]"&&T!=="[object HTMLCollection]"&&(a=[a]);for(var x=0;x<a.length;x++)e(a[x],v)};function e(l,a){if(!i(l)||!a.reProcess&&l.getAttribute("textFitted"))return!1;a.reProcess||l.setAttribute("textFitted",1);var u,v,m,T,x,L,D;if(m=l.innerHTML,T=n(l),v=r(l),!T||!a.widthOnly&&!v)throw a.widthOnly?new Error("Set a static width on the target element "+l.outerHTML+" before using textFit!"):new Error("Set a static height and width on the target element "+l.outerHTML+" before using textFit!");m.indexOf("textFitted")===-1?(u=document.createElement("span"),u.className="textFitted",u.style.display="inline-block",u.innerHTML=m,l.innerHTML="",l.appendChild(u)):(u=l.querySelector("span.textFitted"),o(u,"textFitAlignVert")&&(u.className=u.className.replace("textFitAlignVert",""),u.style.height="",l.className.replace("textFitAlignVertFlex",""))),a.alignHoriz&&(l.style["text-align"]="center",u.style["text-align"]="center");var b=a.multiLine;a.detectMultiLine&&!b&&u.getBoundingClientRect().height>=parseInt(window.getComputedStyle(u)["font-size"],10)*2&&(b=!0),b||(l.style["white-space"]="nowrap"),x=a.minFontSize,D=a.maxFontSize;for(var S=x;x<=D;){L=D+x>>1,u.style.fontSize=L+"px";var V=u.getBoundingClientRect();V.width<=T&&(a.widthOnly||V.height<=v)?(S=L,x=L+1):D=L-1}if(u.style.fontSize!=S+"px"&&(u.style.fontSize=S+"px"),a.alignVert){f();var z=u.scrollHeight;window.getComputedStyle(l).position==="static"&&(l.style.position="relative"),o(u,"textFitAlignVert")||(u.className=u.className+" textFitAlignVert"),u.style.height=z+"px",a.alignVertWithFlexbox&&!o(l,"textFitAlignVertFlex")&&(l.className=l.className+" textFitAlignVertFlex")}}function r(l){var a=window.getComputedStyle(l,null);return l.getBoundingClientRect().height-parseInt(a.getPropertyValue("padding-top"),10)-parseInt(a.getPropertyValue("padding-bottom"),10)}function n(l){var a=window.getComputedStyle(l,null);return l.getBoundingClientRect().width-parseInt(a.getPropertyValue("padding-left"),10)-parseInt(a.getPropertyValue("padding-right"),10)}function i(l){return typeof HTMLElement=="object"?l instanceof HTMLElement:l&&typeof l=="object"&&l!==null&&l.nodeType===1&&typeof l.nodeName=="string"}function o(l,a){return(" "+l.className+" ").indexOf(" "+a+" ")>-1}function f(){if(!document.getElementById("textFitStyleSheet")){var l=[".textFitAlignVert{","position: absolute;","top: 0; right: 0; bottom: 0; left: 0;","margin: auto;","display: flex;","justify-content: center;","flex-direction: column;","}",".textFitAlignVertFlex{","display: flex;","}",".textFitAlignVertFlex .textFitAlignVert{","position: static;","}"].join(""),a=document.createElement("style");a.type="text/css",a.id="textFitStyleSheet",a.innerHTML=l,document.body.appendChild(a)}}})});function We(t,e){let r=Math.hypot(t,e);return[t/r,e/r]}function qe(t,e){return t[0]*e[0]+t[1]*e[1]}function Je(t,e,r){let n=We(t.x-e.x,t.y-e.y),i=qe(n,[r.x-e.x,r.y-e.y]);return[e.x+n[0]*i,e.y+n[1]*i]}function te(t,e,r,n){let[i,o]=Je(t,e,r);return i>=Math.min(t.x,e.x)&&i<=Math.max(t.x,e.x)&&o>=Math.min(t.y,e.y)&&o<=Math.max(t.y,e.y)&&Math.hypot(i-r.x,o-r.y)<n}function W(t,e,r){return(e.x-t.x)*(r.y-t.y)-(e.y-t.y)*(r.x-t.x)}function ce(t,e,r,n){return t>e&&([t,e]=[e,t]),r>n&&([r,n]=[n,r]),Math.max(t,r)<=Math.min(e,n)}function de(t,e,r,n){return ce(t.x,e.x,r.x,n.x)&&ce(t.y,e.y,r.y,n.y)&&W(t,e,r)*W(t,e,n)<=0&&W(r,n,t)*W(r,n,e)<=0}function Ye(t,e){var r=Math.cos(t/180*Math.PI),n=-Math.sin(t/180*Math.PI),i=1/Math.max(Math.abs(r),Math.abs(n));return e+=c,r=r*i*e/2+e/2-c/2,n=n*i*e/2+e/2-c/2,[r,n]}var d=class{target;x;y;#e;list;constructor(e,r,n){this.value=e,this.target=n,[this.x,this.y]=Ye(e,r.size)}static normalize(e){for(;e<=-180;)e+=360;for(;e>180;)e-=360;return e}get value(){return this.#e}set value(e){this.#e=d.normalize(e)}angleTo(e){return e instanceof d?this.angleTo(e.value):d.normalize(e-this.#e)}positiveAngleTo(e){let r=this.angleTo(e);return r<0?r+360:r}add(e){return d.normalize(this.#e+e)}},q=class{#e;owner;constructor(e){this.#e=[],this.owner=e}*[Symbol.iterator](){for(var e of this.#e)yield e}add(e){let r=this.#e.findIndex(n=>n.value>e.value);r<0&&(r=this.#e.length),this.#e.splice(r,0,e),e.list=this}indexOf(e){return e instanceof d?this.#e.indexOf(e):typeof e=="number"?(e=d.normalize(e),this.#e.findIndex(r=>r.value==e)):this.#e.findIndex(r=>r.target==e)}angleBetween(e,r){let n=e instanceof d?e:this.directionOf(e),i=r instanceof d?r:this.directionOf(r);if(n==null||i==null)throw new ReferenceError(`either ${e} or ${r} is not part of this list`);return n.angleTo(i)}get count(){return this.#e.length}directionOf(e){let r=this.indexOf(e);if(r<0)throw ReferenceError("${item} is not part of ${this} directions list");return this.#e[r]}link(e,r){let n=this.indexOf(e);n<0?this.add(new d(e,this.owner,r)):this.#e[n].target=r}next(e){let r=this.indexOf(e);if(r<0)throw ReferenceError("${item} is not part of ${this} directions list");return this.#e[r+1]||this.#e[0]}prev(e){let r=this.indexOf(e);if(r<0)throw ReferenceError("${item} is not part of ${this} directions list");return this.#e[r-1]||this.#e.at(-1)}left(e){return this.next(e)}right(e){return this.prev(e)}};function k(t,e){return t>e&&([t,e]=[e,t]),Math.floor(Math.random()*(e-t+1))+t}function ye(t){return t[Math.floor(Math.random()*t.length)]}function J(t){return t.map(e=>({sort:Math.random(),value:e})).sort((e,r)=>e.sort-r.sort).map(e=>e.value)}function H(t){return[...Array(t).keys()]}function O(t){return new Promise(e=>setTimeout(e,t))}var A=["water","iron","food","radioactives"],ve=function(){for(var t=["blue","yellow","green","red"],e=[[null,"water-mining","farming","burning"],["ice",null,"hunting","fire"],["fishy","bio-mining",null,"nuclear"],["frozen","hot mining","ice-farming",null]],r=[["ocean",null,"water","navy","blue"],["dry","water",null,"blue","white"],["mining",null,"iron","olive","yellow"],["populated","food",null,"green","lime"]],n=0;n<4;n++)for(var i=0;i<4;i++)n!=i&&r.push([e[n][i],A[n],A[i],t[n],t[i]]);return r}(),E=class{x;y;type;name;buys;sells;color_in;color_out;constructor(e,r,n){var i=ve[n];this.x=e,this.y=r,this.type=n,this.name=i[0],this.buys=i[1],this.sells=i[2],this.color_in=i[3],this.color_out=i[4]}save(){return[this.x,this.y,this.type]}};function Ne(t,e,r){var n=r/2;return t<n+.6&&t>n-.6&&e<n+.6&&e>n-.6}function be(t){for(var e=J(H(ve.length)),r=0;r<100;r++){for(var n=!1,i=[],o=J(H(t)),f=J(H(t)),l=t/2,a=0;a<t;a++)Ne(o[a]+.5,f[a]+.5,t)&&(n=!0),i.push([o[a]+.5,f[a]+.5,e[a]]);if(!n)return i}return console.error("should not be here"),[]}var Ue=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkGray","DarkGrey","DarkKhaki","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DodgerBlue","FireBrick","FloralWhite","Fuchsia","Gainsboro","GhostWhite","Gold","Goldenrod","Gray","GreenYellow","Grey","Honeydew","HotPink","IndianRed","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightGrey","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Orange","OrangeRed","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Red","RosyBrown","RoyalBlue","Salmon","SandyBrown","Seashell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"];function Xe(t,e){for(var r=H(e+2*M).map(f=>[]),n=(e-1)/2,i=Math.floor(n);i<=Math.ceil(n);i++)for(var o=Math.floor(n);o<=Math.ceil(n);o++)r[i+1*M][o+1*M]=t;return r}function Ke(t){var e={null:{buys:0,sells:0}};A.forEach(n=>{e[n]={buys:0,sells:0}}),t.forEach(n=>{e[String(n.buys)].buys++,e[String(n.sells)].sells++});var r=0;return A.forEach(n=>{r+=Math.min(e[n].buys,e[n].sells)}),r}var P=class{color;size;visited;x;y;bright;name;neighbours;grid;planets;jobs;constructor(e){if(e||(e={c:ye(Ue),s:k(5,9),n:!1,p:!1,v:!1}),this.color=e.c,this.size=e.s,this.visited=e.v,this.x=this.y=this.size/2,this.bright=!1,this.name=this.color,this.size%2==0&&(this.bright=!0,this.name="bright "+this.name),this.neighbours=new q(this),e.n)for(var r of e.n)this.neighbours.add(new d(r,this));this.grid=Xe(this,this.size),e.p||(e.p=be(this.size)),this.planets=e.p.map(i=>new E(...i));for(var n of this.planets)this.grid[Math.floor(n.x)+1*M][Math.floor(n.y)+1*M]=n;this.jobs=Ke(this.planets)}link(e,r){r instanceof d?(r.target=e,e.neighbours.link(r.value+180,this)):(this.neighbours.link(r,e),e.neighbours.link(r+180,this))}save(){return{c:this.color,s:this.size,n:Array.from(this.neighbours).map(e=>e.value),p:this.planets.map(e=>e.save()),v:this.visited}}};var h;function xe(t){h=t}var N='{"v":1,"s":{"c":"Yellow","s":4,"n":[-134,-71,-18,34,110,177],"p":[[2.5,0.5,3],[1.5,3.5,0],[3.5,2.5,5]],"v":false},"n":[{"c":"LightGreen","s":5,"n":[-145,-80,-8,46,99,151],"p":[[4.5,2.5,2],[1.5,0.5,9],[3.5,3.5,7],[2.5,1.5,12],[0.5,4.5,11]],"v":0},{"c":"LightGray","s":5,"n":[-128,-77,-27,46,109,172],"p":[[2.5,4.5,1],[3.5,2.5,9],[1.5,1.5,10],[0.5,3.5,15],[4.5,0.5,0]],"v":false},{"c":"Peru","s":5,"n":[-134,-79,-52,-9,34,98,162],"p":[[1.5,2.5,9],[4.5,1.5,6],[2.5,4.5,2],[3.5,0.5,0],[0.5,3.5,12]],"v":false},{"c":"Bisque","s":5,"n":[-146,-82,-19,9,52,94,169],"p":[[3.5,1.5,4],[1.5,3.5,9],[2.5,4.5,14],[0.5,2.5,2],[4.5,0.5,10]],"v":false},{"c":"LightBlue","s":6,"n":[-137,-70,-11,41,92,156],"p":[[1.5,3.5,13],[4.5,5.5,4],[5.5,2.5,6],[3.5,0.5,15],[2.5,4.5,3],[0.5,1.5,0]],"v":false},{"c":"LightSeaGreen","s":5,"n":[-144,-81,-3,43,88,154],"p":[[4.5,2.5,13],[3.5,4.5,14],[1.5,0.5,7],[2.5,3.5,11],[0.5,1.5,3]],"v":1}],"f":{"x":-0.25,"y":1.882,"c":null},"st":{"p":0,"s":0,"jf":0,"js":0}}';function Y(t,e,r){return t.neighbours.directionOf(e).angleTo(t.neighbours.directionOf(r))}function we(t,e){var r=[];for(var n of t.neighbours)if(!n.target){var i=new P;t.link(i,n),r.push(i)}var o=t.neighbours.left(e).target;if(!o)throw ReferenceError(`${t} and ${e} have no common neighbour on the left`);var f=t.neighbours.left(o).target;if(!f)throw ReferenceError(`${t} has no neighbour to the left from common neighbour`);var l=o.neighbours.right(t);o.link(f,l);var a=o.neighbours.angleBetween(o.neighbours.right(f),f),u=k(100-a,Math.min(160-a,80));b=new d(f.neighbours.directionOf(o).add(u),f),f.neighbours.add(b);var o=t.neighbours.right(e).target;if(!o)throw ReferenceError(`${t} and ${e} have no common neighbour on the right`);var f=t.neighbours.right(o).target;if(!f)throw ReferenceError(`${t} has no neighbour to the right from common neighbour`);var l=o.neighbours.left(t);o.link(f,l);var a=o.neighbours.angleBetween(f,o.neighbours.left(f)),u=k(100-a,Math.min(160-a,80));b=new d(f.neighbours.directionOf(o).add(-u),f),f.neighbours.add(b);for(var v of r){var m=t.neighbours.directionOf(v),T=t.neighbours.right(m),x=T.target;if(!x)throw ReferenceError(`${t} has no neighbour to the right from ${v}`);if(!(r.indexOf(x)<0)){t.neighbours.left(x).target!=v&&console.error("e0",v,x),m.target!=v&&console.error("e1",m,v);var L=m.add(Math.round(m.angleTo(T)/2));v.link(x,L-90);var a=k(20,80),D=k(100-a,Math.min(160-a,80));(180-a-D<20||180-a-D>80)&&console.error("e3",a,D);var b=new d(v.neighbours.directionOf(x).add(a),v);v.neighbours.add(b);var b=new d(x.neighbours.directionOf(v).add(-D),x);x.neighbours.add(b)}}for(var i of r){for(var S=i.neighbours.next(i.neighbours.next(t)),V=i.neighbours.prev(i.neighbours.prev(t)),z=S.positiveAngleTo(V),ee=0,u=k(20,80);u<z-20;u+=k(20,80)){var b=new d(S.add(u),i);i.neighbours.add(b),ee=u}z-ee>80&&(u=k(ee+20,z-20),b=new d(S.add(u),i),i.neighbours.add(b))}var Re=[t,t.neighbours.left(e).target,t.neighbours.right(e).target];for(var pe of e.neighbours)Re.indexOf(pe.target)<0&&(pe.target=void 0);t.neighbours.left(e).target.neighbours.left(e).target=void 0,t.neighbours.right(e).target.neighbours.right(e).target=void 0}var w;function U(){return{v:1,s:h.save(),n:Array.from(h.neighbours).map(t=>t.target.save()),f:{x:p.steps[0].x,y:p.steps[0].y,c:p.steps[0].cargo},st:w}}function _e(t){if(t.v==1){h=new P(t.s);for(var e=[],r=0;r<t.n.length;r++){var n=new P(t.n[r]);e.push(n),h.link(n,t.s.n[r])}for(var i of e){var o=h.neighbours.right(i).target;i.neighbours.left(h).target=o,o.neighbours.right(h).target=i}p.init(t.f.x,t.f.y,t.f.c,document.getElementById("myFlightplan")),w=t.st}}function re(){var t=!0;for(var e of h.neighbours){if(!e.target){console.error("player_star has no neighbour at",e.value),t=!1;continue}d.normalize(e.value+180)!=e.target.neighbours.directionOf(h).value&&(console.error("player_star and ... dont point to each other",e.target.name,d.normalize(e.value+180),e.target.neighbours.directionOf(h).value),t=!1),h.neighbours.left(e).target!=e.target.neighbours.right(h).target&&(console.error("left (as seen from player_star) and right from ... dont match",e.target.name),t=!1),h.neighbours.right(e).target!=e.target.neighbours.left(h).target&&(console.error("right (as seen from player_star) and left from ... dont match",e.target.name),t=!1);var r=e.target.neighbours.next(h),n=r.target;if(!n){console.error("player_star has no neighbour after",e.target.name),t=!1;continue}n.neighbours.directionOf(e.target).value!=d.normalize(r.value+180)&&(console.error("neighbours dont point to each other",e.target.name,n.name,n.neighbours.directionOf(e.target).value,d.normalize(r.value+180)),t=!1),Y(e.target,e.target.neighbours.prev(n),n)+Y(n,e.target,n.neighbours.next(e.target))<100&&(console.error("future common neighbour of two neighbours will have bad angle",e.target.name,n.name,180-Y(e.target,e.target.neighbours.prev(n),n)-Y(n,e.target,n.neighbours.next(e.target))),t=!1);var i=Array.from(e.target.neighbours).map(f=>f.angleTo(e.target.neighbours.next(f))).filter(f=>Math.abs(f)<20||Math.abs(f)>80);i.length&&(console.error("neighbour has bad angles",e.target.name,i),t=!1)}var i=Array.from(h.neighbours).map(o=>o.angleTo(h.neighbours.next(o))).filter(o=>Math.abs(o)<20||Math.abs(o)>80);return i.length&&(console.error("player_star has bad angles"),t=!1),t}var y;function j(t){y=t}var ne,$;function Se(t,e,r){$=t,e.onmousemove=De,ne=r,e.onmouseleave=function(){ne.innerText="Hover an object on the map to see what it is"},e.onclick=Qe}function Te(t){if(t instanceof d){if(!t.target)return["Portal to unknown"+(_=="test"?" at"+t.value:"")];var e=["Portal to "+Te(t.target)+(_=="test"?" at"+t.value:"")];if(_=="flyi")return e;if(y==h)if(Math.abs(t.x-p.steps[0].x)<.001&&Math.abs(t.y-p.steps[0].y)<.001)e.push("(you are here)");else{var r=p.cantJumpTo(t.target,t);r?e.push("You can't travel there: "+r):e.push("You can travel there")}else t.target==h?e=e.concat(["(you are there)","Click to return"]):t.target.visited&&e.push("(you've been there before)");return t.target!=h&&e.push("Click to explore"),e}else if(t instanceof E){var e=[t.name+" planet"];if(t.buys&&e.push("Buys: "+t.buys),t.sells&&e.push("Sells: "+t.sells),y==h&&_!="flyi"){var r=p.cantTravelTo(t);p.lastStep.planet==t?e.push("Click to remove it from the flight plan"):r?e.push(`Can't travel there: ${r}`):e.push("Click to add it to the flight plan")}return e}else if(t instanceof P)return[t.name+" star"];return["Unknown object"]}function Me(t,e,r){var n=Math.floor(t/g-c),i=Math.floor(e/g-c);if(n<0||n>=$.size||i<0||i>=$.size){var l=F/g;for(var o of $.neighbours){var a=Math.hypot(t/g-o.x-c,e/g-o.y-c);if(a<l)return o}}if($.grid[n]){var f=$.grid[n][i];if(f){var l=R,a=Math.hypot(r.offsetX-(f.x+1*M+c)*g,r.offsetY-(f.y+1*M+c)*g);if(a<l)return f}}}function De(t){let e=Me(t.offsetX,t.offsetY,t);ne.innerHTML=e?Te(e).join("<br>"):"Space void"}function Qe(t){if(_=="flyi")return;let e=Me(t.offsetX,t.offsetY,t);e instanceof E&&y==h&&(p.steps.findIndex(r=>r.planet==e)==p.steps.length-1?(p.undo(),B(),p.element.parentElement.scrollTop=1e3):p.cantTravelTo(e)||(p.add(e),B(),p.element.parentElement.scrollTop=1e3)),e instanceof d&&e.target&&(G(e),De(t))}var ie=class{steps;exitPortal;element;init(e,r,n,i){this.element=i,this.exitPortal=null,this.steps=[{start:!0,planet:{x:e,y:r},x:e,y:r,buy:!1,sell:!1,cargo:n}]}add(e){if(!(this.steps.findIndex(i=>i.planet==e)>=0)){var n=this.lastStep.cargo;this.steps.push({start:!1,planet:e,x:e.x,y:e.y,buy:!1,sell:!1,cargo:n}),this.updateStep(this.steps.length-1)}}undo(){this.steps.length<=1||this.steps.pop()}canSell(e){let r=this.steps[e];return!!r.planet.buys&&this.steps[e-1].cargo==r.planet.buys}setSell(e,r,n){if(!(r&&!this.canSell(e))){var i=this.steps[e];i.sell=r,n||this.updateStep(e,!0,!0)}}canBuy(e){return!!this.steps[e].planet.sells&&(!this.steps[e-1].cargo||this.steps[e].sell)}setBuy(e,r,n){if(r&&!this.canBuy(e))return;let i=this.steps[e];i.buy=r,n||this.updateStep(e,!0)}updateStep(e,r,n){if(e>=this.steps.length)return;let i=this.steps[e];n?i.sell&&!this.canSell(e)&&(i.sell=!1,r=!0):i.sell!=this.canSell(e)&&(i.sell=this.canSell(e),r=!0),i.buy&&!this.canBuy(e)&&(i.buy=!1,r=!0);var o=i.buy?i.planet.sells:i.sell?"":this.steps[e-1].cargo;r=r||i.cargo!=o,i.cargo=o,r&&this.updateStep(e+1)}countJobs(){return this.steps.reduce((e,r)=>e+=+r.sell,0)}get lastStep(){let e=this.steps.at(-1);if(!e)throw new ReferenceError("flighplan should never be empty");return e}canPathTo(e){for(var r=1;r<this.steps.length-1;r++)if(de(this.steps[r-1].planet,this.steps[r].planet,this.lastStep.planet,e))return!1;return!0}pathToCollidesWith(e){if(te(this.lastStep.planet,e,h,.5))return"star";var r=R/g;for(var n of h.planets)if(n!=e&&n!=this.lastStep.planet&&te(this.lastStep.planet,e,n,r))return n.name+" planet";return!1}cantTravelTo(e){if(this.steps.findIndex(n=>n.planet==e)>=0)return"planet already in flight plan";if(_=="easy")return!1;if(!this.canPathTo(e))return"crosses existing path";var r=this.pathToCollidesWith(e);return r?"path crosses "+r:!1}cantJumpTo(e,r){if(e==h)return"you're currently at this star";if(e.visited)return"you've already been here";if(_=="easy")return!1;if(!this.canPathTo(r))return"path to portal crosses existing path";var n=this.pathToCollidesWith(r);return n?"path crosses "+n:!1}toXY(){var e=p.steps.map(r=>[r.x,r.y]);return p.exitPortal&&e.push([p.exitPortal.x,p.exitPortal.y]),e}toKeyFrames(){for(var e=this.toXY(),r=e.map((a,u,v)=>u==0?0:Math.hypot(a[0]-v[u-1][0],a[1]-v[u-1][1])),n=[0],i=1;i<r.length;i++)n[i]=n[i-1]+r[i];var o=n.at(-1)||0,f=n.map(a=>Math.round(a/o*100)),l=f.map((a,u)=>`${f[u]}% { left:${(e[u][0]+c)*g+2}px; top:${(e[u][1]+c)*g+2}px }`);return l.join(" ")}},p=new ie;function ae(){var t=p.steps.map((r,n)=>{var i=[];return r.start?(r=r,i.push(`Arrived to <b>${h.name} star</b>`+(r.cargo?` with ${r.cargo}`:""))):(r=r,i.push(`<div><b>${n}: ${r.planet.name} planet</b>`),r.planet.buys&&i.push(`<label><input type="checkbox" ${r.sell?"checked":""} ${p.canSell(n)?"":"disabled"} onchange="flightplan.setSell(${n},this.checked);redrawFlightplan()"> Sell ${r.planet.buys}</label>`),r.planet.sells&&i.push(`<label><input type="checkbox" ${r.buy?"checked":""} ${p.canBuy(n)?"":"disabled"} onchange="flightplan.setBuy(${n},this.checked);redrawFlightplan()"> Buy ${r.planet.sells}</label>`),i.push("</div>"),r.cargo?i.push(`Travel with ${r.cargo}`):i.push("Travel empty")),i.join(" ")}).join(" ");if(p.element.innerHTML=t,s("fp_undo").style.display=p.steps.length<=1?"none":"",s("fp_hint").style.display=y==h?"":"none",s("fp_jobs_done").innerText=""+p.countJobs(),s("fp_jobs_total").innerText=""+h.jobs,s("fp_jump").style.display=y==h?"none":"",y!=h){var e=p.cantJumpTo(y,h.neighbours.directionOf(y));s("fp_jump_ok").style.display=e?"none":"",s("fp_jump_ok_star").innerText=y.name+" star",s("fp_jump_ok_jobs").innerText=""+y.jobs,s("fp_jump_no").style.display=e?"":"none",s("fp_jump_no_reason").innerText=e||""}}var R=0,g=0,F=0,M=0,c=.5;function Ze(t,e){let r=(e.x+1*M+c)*g,n=(e.y+1*M+c)*g;var i=t.createRadialGradient(r-1,n-1,2,r,n,R);i.addColorStop(0,e.color_in),i.addColorStop(1,e.color_out),t.fillStyle=i,t.beginPath(),t.arc(r,n,R,0,6),t.fill()}function oe(t,e){var r=(e.x+c)*g,n=(e.y+c)*g;e.target==h&&tt(t,r,n,e.value),t.strokeStyle="purple",e.target&&(t.strokeStyle="violet"),t.lineWidth=3;var i=Math.PI*F,o=Math.round(i/3),f=i/o;t.setLineDash([f,f]),t.beginPath(),t.arc(r,n,F,0,7),t.stroke()}function et(t,e,r){let i=(F*2+2)*2;s("player_here").style.left=e-i/2+2+"px",s("player_here").style.top=r-i/2+2+"px",s("player_here").style.width=i+"px",s("player_here").style.height=i+"px"}function tt(t,e,r,n){let i=F*1.73,o=function(u){return i*Math.cos((u+n)/180*Math.PI)+e},f=function(u){return-i*Math.sin((u+n)/180*Math.PI)+r};t.strokeStyle="purple",t.lineWidth=4,t.setLineDash([1,0]),t.beginPath();let l=150,a=120;t.moveTo(o(l),f(l)),t.lineTo(o(a),f(a)),t.lineTo(o(0),f(0)),t.lineTo(o(-a),f(-a)),t.lineTo(o(-l),f(-l)),t.stroke()}function se(t,e){var r=t.canvas.width;g=r/(e.size+2*M+2*c),R=g/5,F=c*g/5}function le(t,e){se(t,e);var r=t.canvas.width,n=r/2;if(t.clearRect(0,0,r,r),e.bright){var i=t.createRadialGradient(n,n,0,n,n,g/2);i.addColorStop(0,"white"),i.addColorStop(.5,e.color),i.addColorStop(1,"transparent"),t.fillStyle=i,t.fillRect(0,0,r,r)}else{var i=t.createRadialGradient(n,n,10,n,n,g/2);i.addColorStop(0,e.color),i.addColorStop(1,"transparent"),t.fillStyle=i,t.fillRect(0,0,r,r)}if(e==h){t.beginPath();var o=(p.steps[0].x+c)*g,f=(p.steps[0].y+c)*g;t.moveTo(o,f);for(var l=1;l<p.steps.length;l++){var a=(p.steps[l].x+c)*g,u=(p.steps[l].y+c)*g;t.lineTo(a,u)}if(p.exitPortal){var a=(p.exitPortal.x+c)*g,u=(p.exitPortal.y+c)*g;t.lineTo(a,u)}t.strokeStyle="purple",t.setLineDash([6,6]),t.lineWidth=3,t.stroke(),et(t,o,f)}for(var v of e.planets)Ze(t,v);for(var m of e.neighbours)oe(t,m)}var Fe=ge(Ce());function s(t){let e=document.getElementById(t);if(!e)throw ReferenceError(`element ${t} not found`);return e}function C(t){let e=s(t);if(!(e instanceof HTMLInputElement))throw ReferenceError(`element ${t} is not input`);return e}var _,Oe=s("myCanvas"),Ee=Oe.getContext("2d"),X,K,Q,Le;location.hostname=="localhost"?K=1e3*10:K=1e3*60*60*10;function B(){le(Ee,y),Se(y,Oe,s("hints")),ae(),s("mapTitle_player").style.display=y==h?"":"none",s("mapTitle_neighbour").style.display=y==h?"none":"",s("player_here").style.display=y==h?"":"none",y!=h&&(s("mapTitle_neighbour_n").innerText=""+(h.neighbours.indexOf(y)+1),s("mapTitle_neighbour_total").innerText=""+h.neighbours.count),s("stats_s").innerText=""+w.s,s("stats_p").innerText=""+w.p,s("stats_js").innerText=""+w.js,s("stats_jf").innerText=""+w.jf,s("stats_jf_s").innerText=""+Math.round(w.jf/w.s*100)/100,s("stats_jf_p").innerText=""+Math.round(w.jf/w.p*100),s("stats_jf_js").innerText=""+Math.round(w.jf/w.js*100)}window.onhashchange=async function(){if(document.querySelectorAll("dialog[open]").forEach(n=>n.close()),s("main").style.display="none",Z(!1),s("profile").style.display="none",_=location.hash.slice(1),["test","easy","hard","real"].indexOf(_)==-1){history.replaceState(0,"",location.pathname),s("select_mode").showModal();return}if(document.title=`space2d2 - ${_} mode`,fe=nt,_=="test")return I(JSON.parse(N));if(["easy","hard"].indexOf(_)>-1)return I(JSON.parse(localStorage["space2d2"+_]||N));let e=(await import("../pocketbase/pocketbase.es.mjs")).default;var r;location.hostname=="localhost"?r=new e("http://127.0.0.1:8090"):r=new e("/"),window.pb=r,fe=async function(){if(X)r.collection("real").update(X,{data:U()});else{var n=await r.collection("real").create({user:r.authStore.model.id,data:U()});X=n.id}},r.collection("users").authRefresh({},{expand:"real(user)"}).then(Be,()=>rt(r))};function rt(t){window.login=function(){t.collection("users").authWithPassword(C("login_email").value,C("login_password").value,{},{expand:"real(user)"}).then(e=>{s("login").close(),Be(e)},e=>{console.log(e),C("login_failure").style.display="",C("login_details").innerText=JSON.stringify(e.response,null,2)})},window.register=function(){t.collection("users").create({email:C("register_email").value,emailVisibility:!0,password:C("register_password").value,passwordConfirm:C("register_password").value}).then(async e=>{C("login_email").value=C("register_email").value,C("login_password").value=C("register_password").value,s("register").close(),s("register_to_login").showModal()},e=>{console.log(e),s("register_failure").style.display="",s("register_details").innerText=JSON.stringify(e.response,null,2)})},s("login").showModal()}function Be(t){let e=t.record.expand["real(user)"];if(s("profile").style.display="",s("profile_name").innerText=t.record.email,s("profile_id").innerText=t.record.id,!e||!e.data)return I(JSON.parse(N));if(X=e.id,Q=new Date(e.updated).getTime()+K,Q<=new Date().getTime())return I(e.data);I(e.data),Z(!0)}function ke(){let t=Q-new Date().getTime();s("flyi_time").firstChild.innerText=""+new Date(t).toISOString().substring(11,19),t<=1e3&&Z(!1)}function Z(t){s("mapTitle_flying").style.display=t?"":"none",s("mapTitle_player").style.display=t?"none":"",s("fpTitle_normal").style.display=t?"none":"",s("fpTitle_flyi").style.display=t?"":"none",s("myFlightplan").style.display=t?"none":"",s("fp_hint").style.display=t?"none":"",s("fp_flyi").style.display=t?"":"none",s("player_here").style.display=t?"none":"",_=t?"flyi":"real",t?((0,Fe.default)(s("flyi_time"),{detectMultiLine:!1,widthOnly:!0}),s("flyi_cargo_with").style.display=p.steps[0].cargo?"":"none",s("flyi_cargo").innerText=p.steps[0].cargo||"",Le=setInterval(ke,1e3),ke()):clearInterval(Le)}function I(t){s("main").style.display="flex",_e(t),re()||alert("universe error, check console"),j(h),B()}var fe,nt=function(){localStorage["space2d2"+_]=JSON.stringify(U())},he;async function G(t,e,r){if(e?(t=h.neighbours.directionOf(y),j(h),B()):t instanceof P&&(t=y.neighbours.directionOf(t)),!t.target)return;he=t.target;let n=s("navigate_ring"),i=F*2+4;n.width=i,n.height=i;let o=new d(90+45,y,new P),f=document.createElement("canvas");f.width=f.height=(o.x+c)*g*2,oe(f.getContext("2d"),o);let l=(o.x+c)*g-i/2+2,a=(o.y+c)*g-i/2+2;n.getContext("2d").drawImage(f,-l+2,-a+2);let u=(t.x+c)*g-i/2+2,v=(t.y+c)*g-i/2+2,m=s("navigate_star"),T=F*2,x=(t.x+c)*g-T/2+2,L=(t.y+c)*g-T/2+2,D=m.getContext("2d");if(le(D,he),se(Ee,y),n.style.display="",m.style.display="",n.style.transitionDuration=m.style.transitionDuration="0s",e){var b=150,S=400;n.style.left=n.style.top=`-${b}px`,n.style.width=n.style.height=`${2*b+500}px`,n.style.transitionTimingFunction=m.style.transitionTimingFunction="ease-out",m.style.left=m.style.top="2px",m.style.width=m.style.height="500px",await O(10),n.style.left=u+"px",n.style.top=v+"px",n.style.width=n.style.height=i+"px",m.style.left=x+"px",m.style.top=L+"px",m.style.width=m.style.height=T+"px",n.style.transitionDuration=m.style.transitionDuration=S+"ms",await O(S+10),m.style.display="none",n.style.display="none"}else{n.style.left=u+"px",n.style.top=v+"px",n.style.width=n.style.height=i+"px",m.style.left=x+"px",m.style.top=L+"px",m.style.width=m.style.height=T+"px",await O(10);var b=r?110:150,S=300;n.style.left=n.style.top=`-${b}px`,n.style.width=n.style.height=`${2*b+500}px`,m.style.left=m.style.top="2px",m.style.width=m.style.height="500px",n.style.transitionTimingFunction=m.style.transitionTimingFunction="ease-out",n.style.transitionDuration=m.style.transitionDuration=S+"ms",await O(S+10);var b=500,S=r?5e3:50;n.style.transitionDuration=S+"ms",n.style.left=n.style.top=`-${b}px`,n.style.width=n.style.height=`${2*b+500}px`,n.style.transitionTimingFunction="linear",j(he),B(),m.style.display="none",r?setTimeout(()=>{n.style.display="none"},S+10):(await O(S+10),n.style.display="none")}}async function it(){if(y==h||y.visited)return;w.s++,w.p+=p.steps.length-1,w.jf+=p.countJobs(),w.js+=h.jobs;let t=y;p.exitPortal=h.neighbours.directionOf(t),await G(h,!0),s("player_travel").style.display="",s("player_travel_css").innerHTML=`@keyframes player_travel {${p.toKeyFrames()}}`,we(t,h);var e=p.lastStep.cargo,r=t.neighbours.directionOf(h);if(p.init(r.x,r.y,e,s("myFlightplan")),h.visited=!0,xe(t),re()||alert("universe error, check console"),(_!="real"||w.s!=1)&&(fe(),Q=new Date().getTime()+K),s("player_here").style.display="none",await O(1310),s("player_travel").style.display="none",await G(h,!1,_=="real"&&w.s>1),_=="real"){if(w.s==1)return s("real_nosave").showModal();Z(!0)}}window.onhashchange();window.jump=it;window.redraw=B;window.flightplan=p;window.redrawFlightplan=ae;window.set_shown_star=j;window.get_shown_star=()=>y;window.get_player_star=()=>h;window.navigateTo=G;location.hostname=="localhost"&&new EventSource("/esbuild").addEventListener("change",()=>location.reload());})();
//# sourceMappingURL=script.js.map
